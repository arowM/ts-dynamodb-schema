/**
 * Type safe schema for DynamoDB.
 * @module
 */
import * as marshaller from "@aws/dynamodb-data-marshaller";
// import {unmarshallItem, marshallValue} from "@aws/dynamodb-data-marshaller";
/**
 * Schema
 */
export class Schema {
}
class BinarySchema extends Schema {
    constructor() {
        super();
    }
    serializeItem() {
        return { type: "Binary" };
    }
}
/**
 * Binary Schema
 */
export const buffer = () => new BinarySchema();
class BooleanSchema extends Schema {
    constructor() {
        super();
    }
    serializeItem() {
        return { type: "Boolean" };
    }
}
/**
 * Boolean Schema
 */
export const boolean = () => new BooleanSchema();
class DateSchema extends Schema {
    constructor() {
        super();
    }
    serializeItem() {
        return { type: "Date" };
    }
}
/**
 * Date Schema
 */
export const date = () => new DateSchema();
class NumberSchema extends Schema {
    constructor() {
        super();
    }
    serializeItem() {
        return { type: "Number" };
    }
}
/**
 * Number Schema.
 */
export const number = () => new NumberSchema();
class StringSchema extends Schema {
    constructor() {
        super();
    }
    serializeItem() {
        return { type: "String" };
    }
}
/**
 * String Schema.
 */
export const string = () => new StringSchema();
class ArraySchema extends Schema {
    constructor(schema) {
        super();
        this._schema = schema;
    }
    serializeItem() {
        return {
            type: "List",
            memberType: this._schema.serializeItem(),
        };
    }
}
/**
 * Array Schema
 */
export function array(item) {
    return new ArraySchema(item);
}
class MapSchema extends Schema {
    constructor(schema) {
        super();
        this._schema = schema;
    }
    serializeItem() {
        return {
            type: "Map",
            memberType: this._schema.serializeItem(),
        };
    }
}
/**
 * Map Schema
 */
export function map(item) {
    return new MapSchema(item);
}
class SetSchema extends Schema {
    constructor(schema) {
        super();
        this._schema = schema;
    }
    memberType() {
        if (this._schema instanceof BinarySchema) {
            return "Binary";
        }
        if (this._schema instanceof NumberSchema) {
            return "Number";
        }
        if (this._schema instanceof StringSchema) {
            return "String";
        }
        throw new Error("Invalid Set");
    }
    serializeItem() {
        return {
            type: "Set",
            memberType: this.memberType(),
        };
    }
}
/**
 * Set Schema
 */
export function set(item) {
    return new SetSchema(item);
}
class NullableSchema extends Schema {
    constructor(schema) {
        super();
        this._schema = schema;
    }
    marshall(input) {
        if (input === null) {
            return {
                NULL: true,
            };
        }
        const serialized = marshaller.marshallValue(this._schema.serializeItem(), input);
        if (serialized === void 0) {
            throw new Error("Failed to marshallValue");
        }
        return serialized;
    }
    unmarshall(input) {
        if ("NULL" in input) {
            return null;
        }
        const deserialized = marshaller.unmarshallItem({ foo: this._schema.serializeItem() }, { foo: input });
        return deserialized.foo;
    }
    serializeItem() {
        return {
            type: "Custom",
            marshall: this.marshall.bind(this),
            unmarshall: this.unmarshall.bind(this),
        };
    }
}
/**
 * Nullable Schema
 */
export function nullable(item) {
    return new NullableSchema(item);
}
/**
 * Object Schema
 */
// eslint-disable-next-line @typescript-eslint/no-explicit-any
export class ObjectSchema extends Schema {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    constructor(schema) {
        super();
        this.shape = schema;
    }
    /** Asign required field.
     *
     * Note that `Schema` cannot handle objects with any optional fields.
     */
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    field(name, schema) {
        return new ObjectSchema({
            ...this.shape,
            [name]: schema,
        });
    }
    serializeValue() {
        return Object.fromEntries(Object.entries(this.shape).map(([key, schema]) => [
            key,
            schema.serializeItem(),
        ]));
    }
    serializeItem() {
        return {
            type: "Document",
            members: this.serializeValue(),
        };
    }
    marshallItem(input) {
        return marshaller.marshallItem(this.serializeValue(), input);
    }
    unmarshallItem(input) {
        const schema = this.serializeValue();
        const ret = marshaller.unmarshallItem(schema, input);
        // It seems that marshaller.unmarshallItem has a bug...
        Object.keys(this.shape).forEach((key) => {
            if (ret[key] === void 0) {
                throw new Error(`Value for property ${key} is unexpected.\nExpected: ${JSON.stringify(schema[key])}\nActual: ${JSON.stringify(input[key])}`);
            }
        });
        return ret;
    }
}
/** Empty `ObjectSchema`.
 *
 * Used for the entry point to build a complex object.
 */
// eslint-disable-next-line @typescript-eslint/ban-types
ObjectSchema.empty = () => new ObjectSchema({});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBR0gsT0FBTyxLQUFLLFVBQVUsTUFBTSwrQkFBK0IsQ0FBQztBQUM1RCwrRUFBK0U7QUFFL0U7O0dBRUc7QUFDSCxNQUFNLE9BQWdCLE1BQU07Q0FLM0I7QUFTRCxNQUFNLFlBQWEsU0FBUSxNQUFxQztJQUM5RDtRQUNFLEtBQUssRUFBRSxDQUFDO0lBQ1YsQ0FBQztJQUNNLGFBQWE7UUFDbEIsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQztJQUM1QixDQUFDO0NBQ0Y7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLE1BQU0sR0FBZ0QsR0FBRyxFQUFFLENBQ3RFLElBQUksWUFBWSxFQUFFLENBQUM7QUFFckIsTUFBTSxhQUFjLFNBQVEsTUFBZTtJQUN6QztRQUNFLEtBQUssRUFBRSxDQUFDO0lBQ1YsQ0FBQztJQUNNLGFBQWE7UUFDbEIsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQztJQUM3QixDQUFDO0NBQ0Y7QUFFRDs7R0FFRztBQUNILE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBMEIsR0FBRyxFQUFFLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQztBQUV4RSxNQUFNLFVBQVcsU0FBUSxNQUFZO0lBQ25DO1FBQ0UsS0FBSyxFQUFFLENBQUM7SUFDVixDQUFDO0lBQ00sYUFBYTtRQUNsQixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDO0lBQzFCLENBQUM7Q0FDRjtBQUVEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUF1QixHQUFHLEVBQUUsQ0FBQyxJQUFJLFVBQVUsRUFBRSxDQUFDO0FBRS9ELE1BQU0sWUFBYSxTQUFRLE1BQWM7SUFDdkM7UUFDRSxLQUFLLEVBQUUsQ0FBQztJQUNWLENBQUM7SUFDTSxhQUFhO1FBQ2xC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LEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FDNUgsQ0FBQzthQUNIO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7O0FBbEREOzs7R0FHRztBQUNILHdEQUF3RDtBQUMxQyxrQkFBSyxHQUEyQixHQUFHLEVBQUUsQ0FBQyxJQUFJLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVHlwZSBzYWZlIHNjaGVtYSBmb3IgRHluYW1vREIuXG4gKiBAbW9kdWxlXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBBdHRyaWJ1dGVWYWx1ZSwgQXR0cmlidXRlTWFwIH0gZnJvbSBcImF3cy1zZGsvY2xpZW50cy9keW5hbW9kYlwiO1xuaW1wb3J0ICogYXMgbWFyc2hhbGxlciBmcm9tIFwiQGF3cy9keW5hbW9kYi1kYXRhLW1hcnNoYWxsZXJcIjtcbi8vIGltcG9ydCB7dW5tYXJzaGFsbEl0ZW0sIG1hcnNoYWxsVmFsdWV9IGZyb20gXCJAYXdzL2R5bmFtb2RiLWRhdGEtbWFyc2hhbGxlclwiO1xuXG4vKipcbiAqIFNjaGVtYVxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2NoZW1hPFQ+IHtcbiAgLyoqIERPIE5PVCBBQ0NFU1MgVEhJUyFcbiAgICovXG4gIHJlYWRvbmx5IF9JX0FNX0ZPT0xfRU5PVUdIX1RPX0FDQ0VTU19USElTITogVDtcbiAgYWJzdHJhY3Qgc2VyaWFsaXplSXRlbSgpOiBtYXJzaGFsbGVyLlNjaGVtYVR5cGU7XG59XG5cbi8qKlxuICogSW5mZXIgdHlwZSBvZiBTY2hlbWEuXG4gKi9cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5leHBvcnQgdHlwZSBpbmZlcjxTIGV4dGVuZHMgU2NoZW1hPGFueT4+ID1cbiAgU1tcIl9JX0FNX0ZPT0xfRU5PVUdIX1RPX0FDQ0VTU19USElTXCJdO1xuXG5jbGFzcyBCaW5hcnlTY2hlbWEgZXh0ZW5kcyBTY2hlbWE8QXJyYXlCdWZmZXIgfCBBcnJheUJ1ZmZlclZpZXc+IHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuICBwdWJsaWMgc2VyaWFsaXplSXRlbSgpOiBtYXJzaGFsbGVyLlNjaGVtYVR5cGUge1xuICAgIHJldHVybiB7IHR5cGU6IFwiQmluYXJ5XCIgfTtcbiAgfVxufVxuXG4vKipcbiAqIEJpbmFyeSBTY2hlbWFcbiAqL1xuZXhwb3J0IGNvbnN0IGJ1ZmZlcjogKCkgPT4gU2NoZW1hPEFycmF5QnVmZmVyVmlldyB8IEFycmF5QnVmZmVyPiA9ICgpID0+XG4gIG5ldyBCaW5hcnlTY2hlbWEoKTtcblxuY2xhc3MgQm9vbGVhblNjaGVtYSBleHRlbmRzIFNjaGVtYTxib29sZWFuPiB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gIH1cbiAgcHVibGljIHNlcmlhbGl6ZUl0ZW0oKTogbWFyc2hhbGxlci5TY2hlbWFUeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiBcIkJvb2xlYW5cIiB9O1xuICB9XG59XG5cbi8qKlxuICogQm9vbGVhbiBTY2hlbWFcbiAqL1xuZXhwb3J0IGNvbnN0IGJvb2xlYW46ICgpID0+IFNjaGVtYTxib29sZWFuPiA9ICgpID0+IG5ldyBCb29sZWFuU2NoZW1hKCk7XG5cbmNsYXNzIERhdGVTY2hlbWEgZXh0ZW5kcyBTY2hlbWE8RGF0ZT4ge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVJdGVtKCk6IG1hcnNoYWxsZXIuU2NoZW1hVHlwZSB7XG4gICAgcmV0dXJuIHsgdHlwZTogXCJEYXRlXCIgfTtcbiAgfVxufVxuXG4vKipcbiAqIERhdGUgU2NoZW1hXG4gKi9cbmV4cG9ydCBjb25zdCBkYXRlOiAoKSA9PiBTY2hlbWE8RGF0ZT4gPSAoKSA9PiBuZXcgRGF0ZVNjaGVtYSgpO1xuXG5jbGFzcyBOdW1iZXJTY2hlbWEgZXh0ZW5kcyBTY2hlbWE8bnVtYmVyPiB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gIH1cbiAgcHVibGljIHNlcmlhbGl6ZUl0ZW0oKTogbWFyc2hhbGxlci5TY2hlbWFUeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiBcIk51bWJlclwiIH07XG4gIH1cbn1cblxuLyoqXG4gKiBOdW1iZXIgU2NoZW1hLlxuICovXG5leHBvcnQgY29uc3QgbnVtYmVyOiAoKSA9PiBTY2hlbWE8bnVtYmVyPiA9ICgpID0+IG5ldyBOdW1iZXJTY2hlbWEoKTtcblxuY2xhc3MgU3RyaW5nU2NoZW1hIGV4dGVuZHMgU2NoZW1hPHN0cmluZz4ge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVJdGVtKCk6IG1hcnNoYWxsZXIuU2NoZW1hVHlwZSB7XG4gICAgcmV0dXJuIHsgdHlwZTogXCJTdHJpbmdcIiB9O1xuICB9XG59XG5cbi8qKlxuICogU3RyaW5nIFNjaGVtYS5cbiAqL1xuZXhwb3J0IGNvbnN0IHN0cmluZzogKCkgPT4gU2NoZW1hPHN0cmluZz4gPSAoKSA9PiBuZXcgU3RyaW5nU2NoZW1hKCk7XG5cbmNsYXNzIEFycmF5U2NoZW1hPFQ+IGV4dGVuZHMgU2NoZW1hPFRbXT4ge1xuICByZWFkb25seSBfc2NoZW1hITogU2NoZW1hPFQ+O1xuICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYTxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVJdGVtKCk6IG1hcnNoYWxsZXIuU2NoZW1hVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiTGlzdFwiLFxuICAgICAgbWVtYmVyVHlwZTogdGhpcy5fc2NoZW1hLnNlcmlhbGl6ZUl0ZW0oKSxcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogQXJyYXkgU2NoZW1hXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhcnJheTxUPihpdGVtOiBTY2hlbWE8VD4pOiBTY2hlbWE8VFtdPiB7XG4gIHJldHVybiBuZXcgQXJyYXlTY2hlbWEoaXRlbSk7XG59XG5cbmNsYXNzIE1hcFNjaGVtYTxUPiBleHRlbmRzIFNjaGVtYTxNYXA8c3RyaW5nLCBUPj4ge1xuICByZWFkb25seSBfc2NoZW1hITogU2NoZW1hPFQ+O1xuICBjb25zdHJ1Y3RvcihzY2hlbWE6IFNjaGVtYTxUPikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5fc2NoZW1hID0gc2NoZW1hO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVJdGVtKCk6IG1hcnNoYWxsZXIuU2NoZW1hVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiTWFwXCIsXG4gICAgICBtZW1iZXJUeXBlOiB0aGlzLl9zY2hlbWEuc2VyaWFsaXplSXRlbSgpLFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBNYXAgU2NoZW1hXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtYXA8VD4oaXRlbTogU2NoZW1hPFQ+KTogU2NoZW1hPE1hcDxzdHJpbmcsIFQ+PiB7XG4gIHJldHVybiBuZXcgTWFwU2NoZW1hKGl0ZW0pO1xufVxuXG5jbGFzcyBTZXRTY2hlbWE8XG4gIFQgZXh0ZW5kcyBBcnJheUJ1ZmZlciB8IEFycmF5QnVmZmVyVmlldyB8IG51bWJlciB8IHN0cmluZ1xuPiBleHRlbmRzIFNjaGVtYTxTZXQ8VD4+IHtcbiAgcmVhZG9ubHkgX3NjaGVtYSE6IFNjaGVtYTxUPjtcbiAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWE8VD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NjaGVtYSA9IHNjaGVtYTtcbiAgfVxuXG4gIHByaXZhdGUgbWVtYmVyVHlwZSgpOiBcIlN0cmluZ1wiIHwgXCJOdW1iZXJcIiB8IFwiQmluYXJ5XCIge1xuICAgIGlmICh0aGlzLl9zY2hlbWEgaW5zdGFuY2VvZiBCaW5hcnlTY2hlbWEpIHtcbiAgICAgIHJldHVybiBcIkJpbmFyeVwiO1xuICAgIH1cbiAgICBpZiAodGhpcy5fc2NoZW1hIGluc3RhbmNlb2YgTnVtYmVyU2NoZW1hKSB7XG4gICAgICByZXR1cm4gXCJOdW1iZXJcIjtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3NjaGVtYSBpbnN0YW5jZW9mIFN0cmluZ1NjaGVtYSkge1xuICAgICAgcmV0dXJuIFwiU3RyaW5nXCI7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgU2V0XCIpO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVJdGVtKCk6IG1hcnNoYWxsZXIuU2NoZW1hVHlwZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiU2V0XCIsXG4gICAgICBtZW1iZXJUeXBlOiB0aGlzLm1lbWJlclR5cGUoKSxcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogU2V0IFNjaGVtYVxuICovXG5leHBvcnQgZnVuY3Rpb24gc2V0PFQgZXh0ZW5kcyBBcnJheUJ1ZmZlciB8IEFycmF5QnVmZmVyVmlldyB8IG51bWJlciB8IHN0cmluZz4oXG4gIGl0ZW06IFNjaGVtYTxUPlxuKTogU2NoZW1hPFNldDxUPj4ge1xuICByZXR1cm4gbmV3IFNldFNjaGVtYShpdGVtKTtcbn1cblxuY2xhc3MgTnVsbGFibGVTY2hlbWE8VD4gZXh0ZW5kcyBTY2hlbWE8VCB8IG51bGw+IHtcbiAgcmVhZG9ubHkgX3NjaGVtYSE6IFNjaGVtYTxUPjtcbiAgY29uc3RydWN0b3Ioc2NoZW1hOiBTY2hlbWE8VD4pIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX3NjaGVtYSA9IHNjaGVtYTtcbiAgfVxuXG4gIHByaXZhdGUgbWFyc2hhbGwoaW5wdXQ6IFQgfCBudWxsKTogQXR0cmlidXRlVmFsdWUge1xuICAgIGlmIChpbnB1dCA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgTlVMTDogdHJ1ZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qgc2VyaWFsaXplZDogQXR0cmlidXRlVmFsdWUgfCB1bmRlZmluZWQgPSBtYXJzaGFsbGVyLm1hcnNoYWxsVmFsdWUoXG4gICAgICB0aGlzLl9zY2hlbWEuc2VyaWFsaXplSXRlbSgpLFxuICAgICAgaW5wdXRcbiAgICApO1xuICAgIGlmIChzZXJpYWxpemVkID09PSB2b2lkIDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkZhaWxlZCB0byBtYXJzaGFsbFZhbHVlXCIpO1xuICAgIH1cbiAgICByZXR1cm4gc2VyaWFsaXplZDtcbiAgfVxuXG4gIHByaXZhdGUgdW5tYXJzaGFsbChpbnB1dDogQXR0cmlidXRlVmFsdWUpOiBUIHwgbnVsbCB7XG4gICAgaWYgKFwiTlVMTFwiIGluIGlucHV0KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZGVzZXJpYWxpemVkOiB7IGZvbzogVCB9ID0gbWFyc2hhbGxlci51bm1hcnNoYWxsSXRlbShcbiAgICAgIHsgZm9vOiB0aGlzLl9zY2hlbWEuc2VyaWFsaXplSXRlbSgpIH0sXG4gICAgICB7IGZvbzogaW5wdXQgfVxuICAgICk7XG4gICAgcmV0dXJuIGRlc2VyaWFsaXplZC5mb287XG4gIH1cblxuICBwdWJsaWMgc2VyaWFsaXplSXRlbSgpOiBtYXJzaGFsbGVyLlNjaGVtYVR5cGUge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcIkN1c3RvbVwiLFxuICAgICAgbWFyc2hhbGw6IHRoaXMubWFyc2hhbGwuYmluZCh0aGlzKSxcbiAgICAgIHVubWFyc2hhbGw6IHRoaXMudW5tYXJzaGFsbC5iaW5kKHRoaXMpLFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBOdWxsYWJsZSBTY2hlbWFcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG51bGxhYmxlPFQ+KGl0ZW06IFNjaGVtYTxUPik6IFNjaGVtYTxUIHwgbnVsbD4ge1xuICByZXR1cm4gbmV3IE51bGxhYmxlU2NoZW1hKGl0ZW0pO1xufVxuXG4vKiogVHlwZSBmb3IgYHsgLi4udCwgLi4udiB9YFxuICovXG5leHBvcnQgdHlwZSBNZXJnZWQ8XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIFQgZXh0ZW5kcyBSZWNvcmQ8YW55LCBhbnk+LFxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICBWIGV4dGVuZHMgUmVxdWlyZWQ8UmVjb3JkPGFueSwgYW55Pj5cbj4gPVxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICB7IFtLIGluIGtleW9mIFRdOiBLIGV4dGVuZHMga2V5b2YgViA/IGFueSA6IFRbS10gfSAmIFY7XG5cbi8qKlxuICogT2JqZWN0IFNjaGVtYVxuICovXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuZXhwb3J0IGNsYXNzIE9iamVjdFNjaGVtYTxUIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55Pj4gZXh0ZW5kcyBTY2hlbWE8VD4ge1xuICAvKiogUmV0dXJucyBzaGFwZSBvZiB0aGUgU2NoZW1hLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHNoYXBlITogUmVjb3JkPGtleW9mIFQsIFNjaGVtYTxUW2tleW9mIFRdPj47XG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHByaXZhdGUgY29uc3RydWN0b3Ioc2NoZW1hOiBSZWNvcmQ8a2V5b2YgVCwgU2NoZW1hPGFueT4+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnNoYXBlID0gc2NoZW1hO1xuICB9XG4gIC8qKiBFbXB0eSBgT2JqZWN0U2NoZW1hYC5cbiAgICpcbiAgICogVXNlZCBmb3IgdGhlIGVudHJ5IHBvaW50IHRvIGJ1aWxkIGEgY29tcGxleCBvYmplY3QuXG4gICAqL1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2Jhbi10eXBlc1xuICBwdWJsaWMgc3RhdGljIGVtcHR5OiAoKSA9PiBPYmplY3RTY2hlbWE8e30+ID0gKCkgPT4gbmV3IE9iamVjdFNjaGVtYSh7fSk7XG5cbiAgLyoqIEFzaWduIHJlcXVpcmVkIGZpZWxkLlxuICAgKlxuICAgKiBOb3RlIHRoYXQgYFNjaGVtYWAgY2Fubm90IGhhbmRsZSBvYmplY3RzIHdpdGggYW55IG9wdGlvbmFsIGZpZWxkcy5cbiAgICovXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gIHB1YmxpYyBmaWVsZDxWIGV4dGVuZHMgUmVxdWlyZWQ8UmVjb3JkPHN0cmluZywgYW55Pj4+KFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBzY2hlbWE6IFNjaGVtYTxWW2tleW9mIFZdPlxuICApOiBPYmplY3RTY2hlbWE8TWVyZ2VkPFQsIFY+PiB7XG4gICAgcmV0dXJuIG5ldyBPYmplY3RTY2hlbWE8TWVyZ2VkPFQsIFY+Pih7XG4gICAgICAuLi50aGlzLnNoYXBlLFxuICAgICAgW25hbWVdOiBzY2hlbWEsXG4gICAgfSBhcyBNZXJnZWQ8VCwgVj4pO1xuICB9XG4gIHB1YmxpYyBzZXJpYWxpemVWYWx1ZSgpOiBtYXJzaGFsbGVyLlNjaGVtYSB7XG4gICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgIE9iamVjdC5lbnRyaWVzKHRoaXMuc2hhcGUpLm1hcCgoW2tleSwgc2NoZW1hXSkgPT4gW1xuICAgICAgICBrZXksXG4gICAgICAgIHNjaGVtYS5zZXJpYWxpemVJdGVtKCksXG4gICAgICBdKVxuICAgICk7XG4gIH1cbiAgcHVibGljIHNlcmlhbGl6ZUl0ZW0oKTogbWFyc2hhbGxlci5TY2hlbWFUeXBlIHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJEb2N1bWVudFwiLFxuICAgICAgbWVtYmVyczogdGhpcy5zZXJpYWxpemVWYWx1ZSgpLFxuICAgIH07XG4gIH1cbiAgcHVibGljIG1hcnNoYWxsSXRlbShpbnB1dDogVCk6IEF0dHJpYnV0ZU1hcCB7XG4gICAgcmV0dXJuIG1hcnNoYWxsZXIubWFyc2hhbGxJdGVtKHRoaXMuc2VyaWFsaXplVmFsdWUoKSwgaW5wdXQpO1xuICB9XG4gIHB1YmxpYyB1bm1hcnNoYWxsSXRlbShpbnB1dDogQXR0cmlidXRlTWFwKTogVCB7XG4gICAgY29uc3Qgc2NoZW1hID0gdGhpcy5zZXJpYWxpemVWYWx1ZSgpO1xuICAgIGNvbnN0IHJldDogVCA9IG1hcnNoYWxsZXIudW5tYXJzaGFsbEl0ZW08VD4oc2NoZW1hLCBpbnB1dCk7XG4gICAgLy8gSXQgc2VlbXMgdGhhdCBtYXJzaGFsbGVyLnVubWFyc2hhbGxJdGVtIGhhcyBhIGJ1Zy4uLlxuICAgIE9iamVjdC5rZXlzKHRoaXMuc2hhcGUpLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgaWYgKHJldFtrZXldID09PSB2b2lkIDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBWYWx1ZSBmb3IgcHJvcGVydHkgJHtrZXl9IGlzIHVuZXhwZWN0ZWQuXFxuRXhwZWN0ZWQ6ICR7SlNPTi5zdHJpbmdpZnkoc2NoZW1hW2tleV0pfVxcbkFjdHVhbDogJHtKU09OLnN0cmluZ2lmeShpbnB1dFtrZXldKX1gXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJldDtcbiAgfVxufVxuIl19